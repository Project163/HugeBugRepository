diff --git a/src/java/org/apache/commons/dbcp/datasources/SharedPoolDataSource.java b/src/java/org/apache/commons/dbcp/datasources/SharedPoolDataSource.java
index fe5bbf54..ef8bad3b 100644
--- a/src/java/org/apache/commons/dbcp/datasources/SharedPoolDataSource.java
+++ b/src/java/org/apache/commons/dbcp/datasources/SharedPoolDataSource.java
@@ -194,10 +194,11 @@ public class SharedPoolDataSource
     }
     
     private UserPassKey getUserPassKey(String username, String password) {
-        UserPassKey key = (UserPassKey) userKeys.get(username);
+        String name = username + password;
+        UserPassKey key = (UserPassKey) userKeys.get(name);
         if (key == null) {
             key = new UserPassKey(username, password);
-            userKeys.put(username, key);
+            userKeys.put(name, key);
         }
         return key;
     }
diff --git a/src/java/org/apache/commons/dbcp/datasources/UserPassKey.java b/src/java/org/apache/commons/dbcp/datasources/UserPassKey.java
index b457e4e4..7440f8f8 100644
--- a/src/java/org/apache/commons/dbcp/datasources/UserPassKey.java
+++ b/src/java/org/apache/commons/dbcp/datasources/UserPassKey.java
@@ -82,7 +82,8 @@ class UserPassKey implements Serializable {
     }
 
     public int hashCode() {
-        return (this.username != null ? this.username.hashCode() : 0);
+        return (this.username != null ?
+                (this.username + this.password).hashCode() : 0);
     }
 
     public String toString() {
diff --git a/src/test/org/apache/commons/dbcp/datasources/TestSharedPoolDataSource.java b/src/test/org/apache/commons/dbcp/datasources/TestSharedPoolDataSource.java
index fe45aa84..0c789014 100644
--- a/src/test/org/apache/commons/dbcp/datasources/TestSharedPoolDataSource.java
+++ b/src/test/org/apache/commons/dbcp/datasources/TestSharedPoolDataSource.java
@@ -27,6 +27,7 @@ import javax.sql.DataSource;
 import junit.framework.Test;
 import junit.framework.TestSuite;
 
+import org.apache.commons.dbcp.SQLNestedException;
 import org.apache.commons.dbcp.TestConnectionPool;
 import org.apache.commons.dbcp.cpdsadapter.DriverAdapterCPDS;
 
@@ -102,9 +103,10 @@ public class TestSharedPoolDataSource extends TestConnectionPool {
             ds.getConnection("u1", "x").close();
             fail("Able to retrieve connection with incorrect password");
         }
-        catch (SQLException e)
+        catch (SQLNestedException e)
         {
-            if (!e.getMessage().startsWith("Given password did not match")) 
+            Throwable t = e.getCause();
+            if (!t.getMessage().startsWith("x is not the correct password"))
             {
                 throw e;
             }
