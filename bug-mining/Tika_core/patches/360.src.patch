diff --git a/tika-core/src/main/java/org/apache/tika/detect/NameDetector.java b/tika-core/src/main/java/org/apache/tika/detect/NameDetector.java
index 1b583c151..36d01e171 100644
--- a/tika-core/src/main/java/org/apache/tika/detect/NameDetector.java
+++ b/tika-core/src/main/java/org/apache/tika/detect/NameDetector.java
@@ -116,7 +116,7 @@ public class NameDetector implements Detector {
 
             // Strip any fragments from the end, but only ones after the extension
             int hash = name.lastIndexOf('#');
-            int dot = name.indexOf('.');
+            int dot = name.lastIndexOf('.');
             if (hash != -1) {
                 if (dot == -1 || hash > dot) {
                     name = name.substring(0, hash);
diff --git a/tika-core/src/test/java/org/apache/tika/detect/NameDetectorTest.java b/tika-core/src/test/java/org/apache/tika/detect/NameDetectorTest.java
index a260869ac..dc15299af 100644
--- a/tika-core/src/test/java/org/apache/tika/detect/NameDetectorTest.java
+++ b/tika-core/src/test/java/org/apache/tika/detect/NameDetectorTest.java
@@ -72,6 +72,9 @@ public class NameDetectorTest {
         assertDetect(MediaType.TEXT_PLAIN, "text#123.txt");// # before extension
         assertDetect(MediaType.TEXT_PLAIN, "text.txt#pdf");// # after extension
 
+        // TIKA-3783 # before the final .
+        assertDetect(MediaType.TEXT_PLAIN, "ABC#192.168.0.1#2.txt");
+
         // Check # as URL fragment too
         assertDetect(MediaType.TEXT_PLAIN, "http://foo/test.txt?1=2#pdf");
         assertDetect(MediaType.TEXT_PLAIN, "http://foo/test.txt#pdf");
